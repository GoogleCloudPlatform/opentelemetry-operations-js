version: 2.1

jobs:
  lint:
    docker:
      - image: cimg/node:12
    steps:
      - checkout
      - run:
          name: Install minimal modules globally
          command: npm install
      - run:
          name: Check code style and linting
          command: npm run lint

  unit_tests:
    docker:
      - image: cimg/node:<< parameters.node_version >>
    parameters:
      node_version:
        description: The node version to run the tests with
        type: integer
    steps:
      - checkout
      - run:
          name: Setup environment variables
          command: |
            echo "export CIRCLE_NODE_VERSION=\$(node --version | grep -oE 'v[0-9]+')" >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Log out node.js version
          command: |
            node --version
            echo "CIRCLE_NODE_VERSION=${CIRCLE_NODE_VERSION}"
      - run:
          name: Install Root Dependencies
          command: npm install --ignore-scripts
      - run:
          name: Boostrap dependencies
          command: npx lerna bootstrap --no-ci
      - run:
          name: Unit tests
          command: npm run test
      - run:
          name: Verify package.json dependencies of samples
          command: |
            set +eo pipefail
            for sample_dir in $(realpath samples/*); do
              pushd $sample_dir
              npm ci

              # verify dependencies are met without warnings or errors. Ignore
              # "extraneous" messages, they are because of the local install
              npm ls |& grep -v "extraneous" | grep "ERR!"
              if [ $? -eq 0 ]; then
                >&2 echo "Found dependency errors in $sample_dir package.json"
                exit 1
              else
                exit 0
              fi
              popd
            done
      - run:
          name: report coverage
          command: if [ "${CIRCLE_NODE_VERSION}" = "v12" ]; then npm run codecov; fi

workflows:
  version: 2
  build:
    jobs:
      - lint
      - unit_tests:
          name: unit-tests-node<< matrix.node_version >>
          matrix:
            parameters:
              node_version: [8, 10, 12, 13, 14]
